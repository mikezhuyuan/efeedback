<!DOCTYPE html>
<html lang="en">
	<script src="jquery.js"></script>
	<script src="sockjs.js"></script>
<style>
html,body{margin:0;padding:0}h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,cite,code,del,dfn,em,img,q,s,samp,small,strike,strong,sub,sup,tt,var,dd,dl,dt,li,ol,ul,fieldset,form,label,legend,button,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;font-weight:normal;font-style:normal;font-size:100%;line-height:1;font-family:inherit}table{border-collapse:collapse;border-spacing:0}ol,ul{list-style:none}q:before,q:after,blockquote:before,blockquote:after{content:""}html{overflow-y:scroll;font-size:100%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a:focus{outline:thin dotted}a:hover,a:active{outline:0}article,aside,details,figcaption,figure,footer,header,hgroup,nav,section{display:block}audio,canvas,video{display:inline-block;*display:inline;*zoom:1}audio:not([controls]){display:none}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0;-ms-interpolation-mode:bicubic}button,input,select,textarea{font-size:100%;margin:0;vertical-align:baseline;*vertical-align:middle}button,input{line-height:normal;*overflow:visible}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}button,input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}input[type="search"]{-webkit-appearance:textfield;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}
body{
	font-family: 'Helvetica Neue', arial, sans-serif;
	font-size: 14px;
	font-style: normal;
	font-weight: normal;
	line-height: 22px;
}
</style>
<head>
<body>

<div id="template" style="display:none">
<div class="dialog" style="background: #fff;width: 450px;-webkit-box-shadow:rgba(0, 0, 0, 0.0745098) 0px 1px 2px 0px;background-color:rgb(255, 255, 255);border:1px solid rgb(213, 213, 213);color:rgb(34, 34, 34);padding: 15px;text-align:start;float: left;margin:20px">
	<a class="url" style="display:block; margin-bottom:5px; white-space: nowrap; overflow: hidden;" href="#"></a>
	<div class="context" style="max-height: 120px; overflow-y:auto; overflow-x:hidden; margin-bottom: 10px">
		Morbi in sem quis dui placerat ornare. Pellentesque odio nisi, euismod in, pharetra a, ultricies in, diam. Sed arcu. Cras consequat.
		Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus.
		Phasellus ultrices nulla quis nibh. Quisque a lectus. Donec consectetuer ligula vulputate sem tristique cursus. Nam nulla quam, gravida non, commodo a, sodales sit amet, nisi.
		Pellentesque fermentum dolor. Aliquam quam lectus, facilisis auctor, ultrices ut, elementum vulputate, nunc.
	</div>
	<form class="toolbar" style="border-color:rgb(34, 34, 34);color:rgb(34, 34, 34);text-align:start;vertical-align: middle;line-height: 42px;">                
		<input class="answer" type="text" style="-webkit-box-shadow:rgba(0, 0, 0, 0.0745098) 0px 1px 1px 0px inset;border:1px solid rgb(204, 204, 204);color:rgb(85, 85, 85);font-family:sans-serif;line-height:18px;padding-left:12px;padding-right:10px;padding-top:2px;width:340px;height:34px;border-radius:3px;" value="" />
		<button class="submit" type="submit" style="-webkit-box-shadow:rgba(255, 255, 255, 0.2) 0px 1px 0px 0px inset, rgba(0, 0, 0, 0.0470588) 0px 1px 2px 0px;background-color:rgb(91, 183, 91);background-image:-webkit-linear-gradient(top, rgb(196, 98, 98), rgb(163, 81, 81));border-color:rgba(0, 0, 0, 0.0980392) rgba(0, 0, 0, 0.0980392) rgba(0, 0, 0, 0.247059);border-style:solid;border-width:1px;color:rgb(255, 255, 255);cursor:pointer;font-family:sans-serif;font-size:15px;line-height:normal;padding:9px 14px;text-shadow:rgba(0, 0, 0, 0.247059) 0px -1px 0px;background-repeat:repeat-x;border-radius:5px;">Answer</button>
	</form>
	
	<div class="list">
	<div class="teacher" style="border-top: 1px solid #ccc;padding-top: 15px;margin-top:10px">
		<img class="user" alt="Avatar" src="http://mediacdn.disqus.com/uploads/users/2196/7302/avatar92.jpg?1336454729" 
			style="-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
			border-radius: 3px;
			display: block;
			height: 36px;
			width: 36px;float: left;" />
		<div style="padding-left: 48px;min-height: 50px;">
			<div style="color: rgb(90, 122, 155);
				line-height: 16px;
				font-size: 12px;
				font-weight: 600;">Jane</div>
			<div class="content"></div>
		</div>
	</div>
	
	<div class="student" style="border-top: 1px solid #ccc;padding-top: 15px;margin-top:10px">
		<img class="user" alt="Avatar" src="http://mediacdn.disqus.com/uploads/forums/49/33/avatar92.jpg?1363593733" 
			style="-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
			border-radius: 3px;
			display: block;
			height: 36px;
			width: 36px;float: left;" />
		<div style="padding-left: 48px;min-height: 50px;">
			<div style="color: rgb(90, 122, 155);
				line-height: 16px;
				font-size: 12px;
				font-weight: 600;">Mike</div>
			<div class="content"></div>
		</div>
	</div>
	</div>
</div>
</div>

<script>
var undefined,
	emptyArray = [], 
	slice = emptyArray.slice,
	noop = function(){};

window.net = (function(){
	var sockjs, 
		obj;

	return {
	  connect: function(callback) {
	  	var _this = this;
	  	sockjs = new SockJS('/teacher');		
		
		sockjs.onopen = function()  {
		  sockjs.onmessage = function(e) {
		    var data = JSON.parse(e.data), h;		    
	  		(h = _this.client[data.method]) && h.apply(null, data.args);
		  };

		  callback && callback()
		};

		sockjs.onclose = function()  {
		  console.log('disconnected');
		  _this.onclose && _this.onclose()
		};
	  },

	  server : function(name) {
	    var args = Array.prototype.slice.call(arguments, 1);
	    sockjs.send(JSON.stringify({method:name, args:args}));
	  },

	  client : Object.create(null)
	};
})();

$(function(){	
	var teacherHTML = $('#template .teacher').remove()[0].outerHTML,
		studentHTML = $('#template .student').remove()[0].outerHTML,
	 	dialogHTML = $('#template .dialog')[0].outerHTML,
		students = {},
		dialogs = {};

	function createDialog(studentId, talkId, content, url) {
		var dialog = $(dialogHTML);
		dialog.find('.url').html(url).attr('href', url);
		dialog.find('.context').html(content);
		dialog.find('form').submit(function(e){
			var answer  = dialog.find('.answer').val(),
				teacher = $(teacherHTML);
			
			dialog.find('.answer').val('');
			teacher.find('.content').html(answer);
			dialog.find('.list').prepend(teacher);

			window.net.server('answer', studentId, talkId, answer);

			return false;
		});

		$('body').prepend(dialog);

		if(students[studentId]) 
			students[studentId].push(talkId);
		else
			students[studentId] = [talkId];			

		return (dialogs[studentId + '-' + talkId] = {
			remove : function(){
				dialog.remove();
				delete dialogs[studentId + '-' + talkId];
			},

			ask : function(content){
				var student = $(studentHTML);
			
				student.find('.content').html(content);
				dialog.find('.list').prepend(student);
			}
		});
	}

	window.net.client = {
		startTalk : function(studentId, talkId, content, url){
			createDialog(studentId, talkId, content, url);
		},

		ask : function(studentId, talkId, content){
			dialogs[studentId + '-' + talkId].ask(content);
		},

		closeTalk : function(studentId){
			var itms = students[studentId];
			if(itms) {
				for(var i=0;i<itms.length;i++){
					dialogs[studentId + '-' + itms[i]].remove();
				}
			}

			delete students[studentId];
		}
	}

	window.net.connect(function(){
		
	});
});
</script>
</body>
</html>
